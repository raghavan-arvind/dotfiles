#!/bin/bash
set -e

LOCAL_DIR="${HOME}/.backup"
GDRIVE_DIR="Backup"

if ! gdrive list | rg -q $GDRIVE_DIR; then
    echo "Can't find $GDRIVE_DIR in Google Drive"
    exit 1
fi

GDRIVE_ID=$(gdrive list | rg $GDRIVE_DIR | cut -d" " -f 1)
TEMP=$LOCAL_DIR/backup_temp.tar.xz
FINAL=$LOCAL_DIR/backup.tar.xz
LOG=$LOCAL_DIR/log.txt

# Create backup directory if it doesn't exist.
mkdir -p $LOCAL_DIR

# Create backup zip of home directory.
echo "Making tar backup..."
time tar caf $TEMP -I pigz ${HOME}/Documents -P
mv $TEMP $FINAL

# Upload backup to Google Drive.
echo "Uploading to Google Drive..."
$(command -v gdrive) sync upload --keep-local $LOCAL_DIR $GDRIVE_ID
echo "$(date) - Successfully uploaded to gdrive." >> $LOG
echo "Done!"

# Remove backup files from disk.
rm -rf $TEMP $FINAL
